<div class="builder-layout">
  <!-- Top Bar -->
  <div class="top-bar">
    <div style="flex: 1;">
      <h3 style="margin: 0; font-size: var(--text-lg);">
        {{ builderState.project()?.name || 'Untitled Project' }}
      </h3>
    </div>

    <div style="display: flex; gap: var(--spacing-md);">
      <button class="btn btn-sm btn-secondary" (click)="builderState.undo()" [disabled]="!builderState.canUndo()">
        <span class="material-symbols-outlined">undo</span>
        Undo
      </button>
      <button class="btn btn-sm btn-secondary" (click)="builderState.redo()" [disabled]="!builderState.canRedo()">
        <span class="material-symbols-outlined">redo</span>
        Redo
      </button>
      <button class="btn btn-sm btn-secondary" (click)="onPreview()">
        <span class="material-symbols-outlined">visibility</span>
        Preview
      </button>
      <button class="btn btn-sm btn-primary" (click)="onExportHTML()" [disabled]="isExporting()">
        <span class="material-symbols-outlined">{{ isExporting() ? 'hourglass_empty' : 'download' }}</span>
        {{ isExporting() ? 'Exporting...' : 'Export HTML' }}
      </button>
      <button class="btn btn-sm btn-secondary" (click)="onExportReact()" [disabled]="isExporting()">
        <span class="material-symbols-outlined">{{ isExporting() ? 'hourglass_empty' : 'code' }}</span>
        {{ isExporting() ? 'Exporting...' : 'Export React' }}
      </button>
    </div>
  </div>

  <!-- Left Sidebar: Component Library -->
  <div class="left-sidebar">
    <h4 style="margin-bottom: var(--spacing-lg);">Components</h4>

    <!-- Search -->
    <input
      type="text"
      placeholder="Search components..."
      [value]="searchQuery()"
      (input)="searchQuery.set($any($event.target).value)"
      style="margin-bottom: var(--spacing-lg);"
    />

    <!-- Category Filter -->
    <div style="margin-bottom: var(--spacing-lg); display: flex; flex-wrap: wrap; gap: var(--spacing-sm);">
      <button
        class="btn btn-sm"
        [class.btn-primary]="selectedCategory() === null"
        [class.btn-secondary]="selectedCategory() !== null"
        (click)="selectedCategory.set(null)"
      >
        All
      </button>
      @for (category of categories; track category) {
        <button
          class="btn btn-sm"
          [class.btn-primary]="selectedCategory() === category"
          [class.btn-secondary]="selectedCategory() !== category"
          (click)="selectedCategory.set(category)"
        >
          {{ category }}
        </button>
      }
    </div>

    <!-- Component List -->
    <div class="components-list">
      @for (component of filteredComponents; track component.type) {
        <div class="component-tile" (click)="onAddComponent(component.type)">
          <span class="material-symbols-outlined component-tile-icon">{{ component.icon }}</span>
          <span class="component-tile-label">{{ component.label }}</span>
        </div>
      }
      @empty {
        <p style="color: var(--color-muted); text-align: center;">No components found</p>
      }
    </div>
  </div>

  <!-- Center: Canvas -->
  <div class="canvas-area">
    <div class="canvas-container" style="max-width: 1200px; margin: 0 auto;">
      @if (builderState.activePage(); as page) {
        @if (page.components.length > 0) {
          <div 
            cdkDropList 
            (cdkDropListDropped)="onComponentDrop($event)"
            class="components-drop-list"
          >
            @for (component of page.components; track component.id) {
              <div
                cdkDrag
                class="canvas-component"
                [class.selected]="builderState.selectedComponentId() === component.id"
                (click)="onComponentClick(component.id)"
              >
                <!-- Drag handle -->
                <div class="drag-handle" cdkDragHandle>
                  <span class="material-symbols-outlined">drag_indicator</span>
                </div>

                <!-- Render component preview -->
                <div class="component-preview">
                  <div style="padding: var(--spacing-lg); background: var(--color-surface); border-radius: var(--radius-md);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-md);">
                      <div>
                        <strong>{{ component.type }}</strong>
                        <div style="font-size: var(--text-sm); color: var(--color-muted); margin-top: var(--spacing-xs);">
                          ID: {{ component.id.substring(0, 8) }}...
                        </div>
                      </div>
                      <button
                        class="btn btn-sm"
                        style="background: rgba(255, 99, 71, 0.2); color: tomato; padding: var(--spacing-sm);"
                        (click)="onDeleteComponent(component.id); $event.stopPropagation()"
                      >
                        <span class="material-symbols-outlined">delete</span>
                      </button>
                    </div>
                    
                    <!-- Show some props -->
                    <div style="font-size: var(--text-sm); color: var(--color-muted);">
                      @if (component.props['title']) {
                        <div><strong>Title:</strong> {{ component.props['title'] }}</div>
                      }
                      @if (component.props['heading']) {
                        <div><strong>Heading:</strong> {{ component.props['heading'] }}</div>
                      }
                      @if (component.props['subtitle']) {
                        <div><strong>Subtitle:</strong> {{ component.props['subtitle'] }}</div>
                      }
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <div style="text-align: center; padding: var(--spacing-3xl); color: var(--color-muted);">
            <span class="material-symbols-outlined" style="font-size: 64px; opacity: 0.3;">add_circle</span>
            <p style="margin-top: var(--spacing-md);">Click on a component from the left to get started</p>
          </div>
        }
      }
    </div>
  </div>

  <!-- Right Sidebar: Inspector -->
  <div class="right-sidebar">
    @if (builderState.selectedComponentId(); as selectedId) {
      <app-inspector [componentId]="selectedId"></app-inspector>
    } @else {
      <div>
        <h4 style="margin-bottom: var(--spacing-lg);">Theme</h4>
        <app-theme-editor></app-theme-editor>
      </div>
    }
  </div>

  <!-- Bottom Bar -->
  <div class="bottom-bar">
    <div>
      <span style="color: var(--color-muted);">Ready</span>
    </div>
    <div style="display: flex; gap: var(--spacing-lg);">
      <span>{{ builderState.activePage()?.components?.length || 0 }} components</span>
      <span>Theme: {{ builderState.project()?.themeId }}</span>
    </div>
  </div>
</div>
